require File.expand_path('parameters/appcenter_params.rb', __dir__)

XCCONFIG_PATH = PROJECT_PARAMS[:XCCONFIG_PATH]

# Both values below are specified here so that you see what is required.
# It is suficient to provide those as Environment Variables and omit them
# from the 'appcenter_upload' call.

APPCENTER_OWNER_NAME = APPCENTER_PARAMS[:APPCENTER_OWNER_NAME]
APPCENTER_API_TOKEN = APPCENTER_PARAMS[:APPCENTER_API_TOKEN]
APPCENTER_DESTINATION_GROUP = APPCENTER_PARAMS[:APPCENTER_DESTINATION_GROUP]

# --- AppCenter

desc 'deploy app to AppCenter'
lane :run_appcenter_deploy do |options|
    destinations = options[:destinations] || APPCENTER_DESTINATION_GROUP || "Collaborators"
    notify = options[:notify] || true

    # Retrieve app name from config.
    # Make sure the same name is used in AppCenter
    APPCENTER_APP_NAME = get_xcconfig_value(
      path: XCCONFIG_PATH,
      name: 'V_APP_NAME'
    )

    # Make sure the app name has hyphens instead of whitespaces
    APPCENTER_APP_NAME = APPCENTER_APP_NAME.gsub(" ", "-")

    appcenter_upload(
        api_token: APPCENTER_API_TOKEN,
        owner_name: APPCENTER_OWNER_NAME,
        app_name: APPCENTER_APP_NAME,
        notify_testers: notify,
        destinations: destinations
    )
end
